---
layout:     post
title:      使用高德SDK实现定位打卡功能
subtitle:   模仿钉钉打卡
date:       2019-04-30
author:     JovenHe
header-img: img/post-bg-map.jpg
catalog: true
tags:
    - 地图
    - Android
    


---

近期项目需要类似钉钉打卡的功能，所以在高德地图的基础上进行开发实现，因为钉钉打卡的地图就是高德地图，本文需要结合高德开放明台的[文档](https://lbs.amap.com/api/android-sdk/gettingstarted)来学习使用。

一开始仅仅是三月中旬做了一个案例来简单实现：

## 申请 Key

在高德开放平台申请个人账号

在控制台-我的应用-创建应用-添加key

<img src="https://i.loli.net/2019/03/20/5c91ec1d81f82.png" alt="高德控制台.png" title="高德控制台.png" />
<img src="https://i.loli.net/2019/03/20/5c91ec1da85c2.png" alt="高德应用添加key.png" title="高德应用添加key.png" width="70%" />

按照提示填写即可，在获取中可以看到SHA1与应用签名相关，PackageName与应用包名相关，

提交后可以得到key，并在后续中可以使用

## Android Studio 工程配置

导入jar文件与so库，因为我只需要地图显示与定位的功能，所以只导入Android_Map3D_SDK和AMap_Location，在我的使用中发现Map3D比Map2D的显示更加流畅，在滑动时Map2D卡顿明显

在AndroidManifest中配置权限，application标签中配置Key：

在app的build.gradle配置，确保debug与release版本都有签名

<img src="https://i.loli.net/2019/03/20/5c91f4da8358d.png" alt="build.gradle.png" title="build.gradle.png" width="60%" />

## 地图展示

布局文件中

```xml
<com.amap.api.maps.MapView
    android:id="@+id/map"
    android:layout_width="match_parent"
    android:layout_height="match_parent"/>
```

activity中

```java
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_map);
        mContext = this;
        //获取地图控件引用
        mMapView = findViewById(R.id.map);
        //在activity执行onCreate时执行mMapView.onCreate(savedInstanceState)，创建地图
        mMapView.onCreate(savedInstanceState);

        //初始化地图控制器对象
        if (aMap == null) {
            aMap = mMapView.getMap();
        }
        
    }


    @Override
    protected void onDestroy() {
        super.onDestroy();
        //在activity执行onDestroy时执行mMapView.onDestroy()，销毁地图
        mMapView.onDestroy();
    }

    @Override
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        //在activity执行onSaveInstanceState时执行mMapView.onSaveInstanceState (outState)，保存地图当前的状态
        mMapView.onSaveInstanceState(outState);
    }

    @Override
    protected void onPause() {
        super.onPause();
        //在activity执行onPause时执行mMapView.onPause ()，暂停地图的绘制
        mMapView.onPause();
    }

    @Override
    protected void onResume() {
        super.onResume();
        //在activity执行onResume时执行mMapView.onResume ()，重新绘制加载地图
        mMapView.onResume();
    }
```

做完上面这一步可以看到地图的展示了，展示的是北京的中心点

## 定位实现

定位的实现主要分几步

#### 1.定位自身位置

```java
        //初始化地图控制器对象
        if (aMap == null) {
            aMap = mMapView.getMap();
        }
        MyLocationStyle myLocationStyle;
        myLocationStyle = new MyLocationStyle();
        //只定位一次，并且将页面移动到定位中心
        myLocationStyle.myLocationType(MyLocationStyle.LOCATION_TYPE_LOCATE);
        myLocationStyle.radiusFillColor(Color.parseColor("#00000000"));
        myLocationStyle.strokeWidth(0);
//        myLocationStyle.myLocationIcon();//设置我所在定位点的icon
        //设置定位蓝点的Style
        aMap.setMyLocationStyle(myLocationStyle);
		//设置缩放级别
        aMap.moveCamera(CameraUpdateFactory.zoomTo(17f));
        // 设置为true表示启动显示定位蓝点，false表示隐藏定位蓝点并不进行定位，默认是false。
        aMap.setMyLocationEnabled(true);     
```

给地图控制器设置LocationStyle，使之定位后移动到定位中心，并且设置定位区域的填充颜色与边框宽度，并且设置缩放级别，值越大地图越精细，最大值为19。

如果使用以上代码后并不可行，很大概率是因为Android6以上的动态权限问题和GPS未打开，需要增加权限检测与GPS打开检测

#### 2.设置打卡范围

```java
aMap.setOnMyLocationChangeListener(location -> {
    //清除已添加的图，防止多次定位后图叠加的错误，但不清除小蓝点
    aMap.clear(true);
    Circle circle=aMap.addCircle(new CircleOptions().
            center(new LatLng(36.663869,117.141250)).
            radius(100).
            fillColor(Color.parseColor("#33002194"))
    .strokeWidth(0));

    Toast.makeText(mContext,circle.contains(new LatLng(location.getLatitude(),location.getLongitude()))?"在9号南楼100米内":"不在9号南楼100米内",Toast.LENGTH_SHORT).show();
});
```

这一步是在获取到自身的位置信息后，根据后台设置的公司位置的经纬度以及打卡半径范围生成的一个圆形，并添加到map中，再通过circle.contains这个方法来判断自身的位置是否处于该范围内

本文仅为测试，经纬度是通过使用高德地图的坐标拾取器来得到的，注意LatLng的构造参数第一个是纬度，第二个是经度，而拾取器获取的两个数字第一个是经度，第二个是纬度

<img src="https://i.loli.net/2019/03/20/5c9203046e67e.png" alt="高德坐标拾取器.png" title="高德坐标拾取器.png" />

<img src="https://i.loli.net/2019/03/20/5c9202ec89c6d.png" alt="高德经纬度.png" title="高德经纬度.png" />

#### 3.地图组件设置

```java
mUiSettings = aMap.getUiSettings();
        //设置缩放按钮的显示
        mUiSettings.setZoomControlsEnabled(false);
        //设置默认定位按钮是否显示，非必需设置。
        mUiSettings.setMyLocationButtonEnabled(true);
        //设置比例尺控件是否显示
        mUiSettings.setScaleControlsEnabled(true);
        //设置地图logo显示位置
        mUiSettings.setLogoPosition(AMapOptions.LOGO_POSITION_BOTTOM_RIGHT);
```

这一步是获取UI设置后，控制缩放按钮、定位按钮、比例尺控件、地图logo等控件的显示与位置设置

## 效果图

<img src="https://i.loli.net/2019/03/20/5c9204bd791c3.gif" alt="定位打卡.gif" title="定位打卡.gif" width="60%"/>

以上仅仅是调研过程中所做的案例项目，在实际项目中模仿钉钉打卡是一个稍微复杂的流程，下面是在4月底项目基本完结后所做的总结

## 实际项目

| 钉钉定位打卡页面                                             | 钉钉地图打卡页面                                             |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <img src="https://i.loli.net/2019/04/30/5cc7fc65cf6c4.png" alt="定位打卡.png" title="定位打卡.png" /> | <img src="https://i.loli.net/2019/04/30/5cc7fc667a5e0.png" alt="地图打卡.png" title="地图打卡.png" /> |



