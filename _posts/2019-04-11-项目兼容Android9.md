---
layout:     post
title:      2019-04-11-项目兼容Android9
subtitle:   Android P的网络安全策略
date:       2019-04-07
author:     JovenHe
header-img: img/post-bg-2019-01-10.jpg
catalog: true
tags:
    - Android
    


---

之前做了很长一段时间的POS机应用和逆向App，并没有关注过Android8和Android9的一些新特性。导致今天遇到一个问题，在个别手机上接口报错，一开始我以为是网络问题，但多次尝试后还是报错，拿来同事的手机debug一下

## 报错信息

CLEARTEXT communication to xx.xx.xx.xx not permitted by network security policy

因为网络安全政策不允许明文通信到这个域名。

看到这个报错信息，我就知道是新系统的特性问题，因为拿到同事的手机的时候看了一下系统版本，而且日常浏览微信公众号时看到过新系统有个什么安全特性，有个印象，直接查找Android 9网络安全，就找到原因和解决方案了，是因为Android Pie上的所有应用程序默认都使用HTTPS，我们在项目上使用的是HTTP，所以就报错了。

## 方案1

在build.gradle中把targetSdkVersion 降级回到 27或以下

意在App没有兼容到系统P这一高版本

## 方案2

在 res 下的xml 目录中创建一个名为network_security_config.xml 文件 ，写入内容

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config cleartextTrafficPermitted="true" />
</network-security-config>
```

然后在清单文件AndroidManifest中application 标签内加入

android:networkSecurityConfig="@xml/network_security_config" 

意在告诉系统，允许明文通信

## 方案3

和服务器通信都改为HTTPS。

## 总结

三种方案都能解决问题，最好的方案是方案3，从根本上解决问题，但在实施上不一定能得到支持，其余两种方案都能解决问题，但不确定系统会不会提示用户应用不安全、应用未兼容本系统等问题。

就像当年Android6推出运行时权限一样，不少开发者都觉得麻烦，直接把targetSdkVersion设置为22来逃避这一问题，但这就是趋势，是未来，未来一定是越来越注重信息安全的。

当然问题的产生还是由于没有总结日常开发中需要了解的Android新版本新特性，所以还是要多关注Android的一些新动态的，尤其是和开发相关的。