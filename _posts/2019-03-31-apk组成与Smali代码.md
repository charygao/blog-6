---
layout:     post
title:      apk组成与Smali代码
subtitle:   逆向学习
date:       2019-03-31
author:     JovenHe
header-img: img/post-bg-hook.jpg
catalog: true
tags:
    - 逆向
    - 反编译
    


---

apk文件就是android系统的应用安装包，它的本质是一个压缩包，我们将它解压后可以看到它的大概构成

## apk文件构成

## <img src="https://i.loli.net/2019/04/08/5caae3e5a2a23.png" alt="apk解包.png" title="apk解包.png" />

AndroidManifest.xml是android的清单文件，记录版本号、包名、权限、四大组件等信息

classes.dex是应用内代码经过编译后得到的可用于Dalvik虚拟机执行的文件

lib中存放的是so文件

META-INF中存放的apk的签名相关文件

assets是应用内资源文件，相当于Android项目中的assets文件夹，包括一些字体文件、JS文件、音频、文本、压缩文件等

res是应用内资源文件，相当于Android项目中的res文件夹，包括动画XML文件、drawable、layout布局文件、颜色、strings等文件，在编译时会自动生成索引文件R，在源码中会以R.xxx.yyy来进行使用

resources.arsc是对res目录的一个索引，保存原项目中的drawable、layout、attr、anim、string等文件中的name与id值的对应。

#### 例子1

在逆向中想要找某一个文本变化的方法，文本名是"你发起了一笔收款"

<img src="https://i.loli.net/2019/04/08/5caae3e5ef72f.png" alt="strings.png" title="strings.png" />

直接在strings.xml找到该字符串的名字，name为"ar"，在resources.arsc中进行查找

<img src="https://i.loli.net/2019/04/08/5caae3e5d733e.png" alt="resources_arsc.png" title="resources_arsc.png" />

id为2131230779，从R文件中进行查找2131230779

<img src="https://i.loli.net/2019/04/08/5caae3e5d814d.png" alt="R文件.png" title="R文件.png" />

再进行全局查找aa_msg_receiver_wait_receive，可以找到一个方法

<img src="https://i.loli.net/2019/04/08/5caae3e61aedc.png" alt="代码使用.png" title="代码使用.png" />

其实就是在一个方法中进行判断，返回不同信息

## Smali语言

Smali其实是一门很简单的汇编语言，是用于android系统真正执行的代码，在日常反编译中我们得到的java代码都是工具根据smali得到的，并不是真正的源码，大部分可用，但也会出现反编译出错，或者代码可读性差等错误，所以Smali语言在反编译之路上还是很值得学习的。

学习方法上，我主要是通过对照java源码学习smali语法。

一个activity中如果有多个实例并且有回调，在编译时就会生成多个activity\$1、activity\$2、activity$3文件,代表匿名内部类

```java
.class Lcom/a85/posproject/MainActivity$2;
.super Ljava/lang/Object;
.source "MainActivity.java"

# interfaces
.implements Landroid/view/View$OnClickListener;//接口实现


# annotations
.annotation system Ldalvik/annotation/EnclosingMethod;	//注解
    value = Lcom/a85/posproject/MainActivity;->initView()V
.end annotation

.annotation system Ldalvik/annotation/InnerClass;
    accessFlags = 0x0
    name = null
.end annotation


# instance fields	//普通变量
.field final synthetic this$0:Lcom/a85/posproject/MainActivity;


# direct methods
.method constructor <init>(Lcom/a85/posproject/MainActivity;)V 	//类中的构造函数
    .locals 0
    .param p1, "this$0"    # Lcom/a85/posproject/MainActivity;	//指定了方法的参数

    .line 83
    iput-object p1, p0, Lcom/a85/posproject/MainActivity$2;->this$0:Lcom/a85/posproject/MainActivity;
	//把p1寄存器指向的对象的引用赋值给p0寄存器中的this$0对象
    invoke-direct {p0}, Ljava/lang/Object;-><init>()V	//调用实例的直接方法。 

    return-void
.end method


# virtual methods
.method public onClick(Landroid/view/View;)V
    .locals 2
    .param p1, "view"    # Landroid/view/View;

    .line 86
    iget-object v0, p0, Lcom/a85/posproject/MainActivity$2;->this$0:Lcom/a85/posproject/MainActivity;
	//读取v0寄存器中的对象中的this$0对象的引用值给p0寄存器
    const-string v1, "0"

    invoke-static {v0, v1}, Lcom/a85/posproject/MainActivity;->access$200(Lcom/a85/posproject/MainActivity;Ljava/lang/String;)V
	//调用实例的静态方法
	
    .line 87
    return-void
.end method

```



```java
//头文件
.class public Lcom/a85/posproject/MainActivity;		//包名+类名
.super Landroid/support/v7/app/AppCompatActivity;	//父类类名
.source "MainActivity.java"							//source

# static fields										//静态变量
.field private static final REQUEST_PAY:I = 0x239	//int REQUEST_PAY = 569;	
    //I==int  Z==boolean  B==byte  S==short  C==char  L==long
	//F==float  D==double  V==void    
    //L==对象类型 Ljava/lang/String Landroid/content/Context
    //[==数组类型 int类型 一维是:[I，二维是:[[I  对象类型的数组 例如[Ljava/lang/String
.field private static final REQUEST_SELECT:I = 0x24	//int REQUEST_SELECT = 36;		

.field private static final TAG:Ljava/lang/String;	//String TAG 

.field public static TAG_AMT:Ljava/lang/String;		//String TAG_AMT


# instance fields									//普通变量
.field private aidlDeviceService:Lcom/nld/cloudpos/aidl/AidlDeviceService;

.field private mContext:Landroid/content/Context;

.field private serviceConnection:Landroid/content/ServiceConnection;

.field private strAmt:Lcom/a85/posproject/model/OrderBean;


# direct methods	//直接方法(不能被覆写的方法)
.method static constructor <clinit>()V		////类中final变量的初始化
    .locals 1	//方法内使用的v开口的寄存器个数

    .line 46	//对应java中的行数
    const-class v0, Lcom/a85/posproject/MainActivity;//通过类型索引获取MainActivity的引用赋值给寄存器v0
    invoke-virtual {v0}, Ljava/lang/Class;->getName()Ljava/lang/String;//调用实例的虚方法

    move-result-object v0  				//方法调用指令的返回值必须使用move-result*指令来获取

    sput-object v0, Lcom/a85/posproject/MainActivity;->TAG:Ljava/lang/String;
	//把v0寄存器指向的对象的引用赋值给vBB寄存器中的filed_id对象
    .line 47
    const-string v0, "TAG_AMT"//通过字符串索引高走字符串赋值给寄存器v0

    sput-object v0, Lcom/a85/posproject/MainActivity;->TAG_AMT:Ljava/lang/String;

    return-void
.end method

.method public constructor <init>()V		//类中的构造行数
    .locals 1

    .line 42
    invoke-direct {p0}, Landroid/support/v7/app/AppCompatActivity;-><init>()V
    //调用实例的直接方法

    .line 49
    const/4 v0, 0x0		//将数值符号扩展为32后赋值给寄存器v0

    iput-object v0, p0, Lcom/a85/posproject/MainActivity;->aidlDeviceService:Lcom/nld/cloudpos/aidl/AidlDeviceService;
	//把v0寄存器指向的对象的引用赋值给vBB寄存器中的filed_id对象
    .line 51
    new-instance v0, Lcom/a85/posproject/MainActivity$1;//构造一个指定类型对象的新实例，并将对象引用赋值给v0寄存器，类型符type指定的类型不能是数组类。

    invoke-direct {v0, p0}, Lcom/a85/posproject/MainActivity$1;-><init>(Lcom/a85/posproject/MainActivity;)V

    iput-object v0, p0, Lcom/a85/posproject/MainActivity;->serviceConnection:Landroid/content/ServiceConnection;

    return-void
.end method

.method static synthetic access$000()Ljava/lang/String;//加synthetic修饰符的方法，synthetic是合成的意思，即这个方法在原java代码里面是没有的，是在java编译成Dalvik字节码的时候合成的，后续会详细分析这类方法
    .locals 1

    .line 42
    sget-object v0, Lcom/a85/posproject/MainActivity;->TAG:Ljava/lang/String;

    return-object v0
.end method

.method static synthetic access$102(Lcom/a85/posproject/MainActivity;Lcom/nld/cloudpos/aidl/AidlDeviceService;)Lcom/nld/cloudpos/aidl/AidlDeviceService;
    .locals 0
    .param p0, "x0"    # Lcom/a85/posproject/MainActivity;
    .param p1, "x1"    # Lcom/nld/cloudpos/aidl/AidlDeviceService;

    .line 42
    iput-object p1, p0, Lcom/a85/posproject/MainActivity;->aidlDeviceService:Lcom/nld/cloudpos/aidl/AidlDeviceService;

    return-object p1
.end method

.method static synthetic access$200(Lcom/a85/posproject/MainActivity;Ljava/lang/String;)V
    .locals 0
    .param p0, "x0"    # Lcom/a85/posproject/MainActivity;
    .param p1, "x1"    # Ljava/lang/String;

    .line 42
    invoke-direct {p0, p1}, Lcom/a85/posproject/MainActivity;->startPay(Ljava/lang/String;)V

    return-void
.end method

.method static synthetic access$300(Lcom/a85/posproject/MainActivity;)V
    .locals 0
    .param p0, "x0"    # Lcom/a85/posproject/MainActivity;

    .line 42
    invoke-direct {p0}, Lcom/a85/posproject/MainActivity;->setNullBean()V

    return-void
.end method

.method private initData()V
    .locals 2

    .line 112
    invoke-virtual {p0}, Lcom/a85/posproject/MainActivity;->getIntent()Landroid/content/Intent;

    move-result-object v0

    sget-object v1, Lcom/a85/posproject/MainActivity;->TAG_AMT:Ljava/lang/String;

    invoke-virtual {v0, v1}, Landroid/content/Intent;->getParcelableExtra(Ljava/lang/String;)Landroid/os/Parcelable;

    move-result-object v0

    check-cast v0, Lcom/a85/posproject/model/OrderBean;

    iput-object v0, p0, Lcom/a85/posproject/MainActivity;->strAmt:Lcom/a85/posproject/model/OrderBean;

    .line 113
    invoke-virtual {p0}, Lcom/a85/posproject/MainActivity;->screenOn()V

    .line 116
    iget-object v0, p0, Lcom/a85/posproject/MainActivity;->strAmt:Lcom/a85/posproject/model/OrderBean;

    if-eqz v0, :cond_0

    .line 117
    invoke-direct {p0}, Lcom/a85/posproject/MainActivity;->startRing()V

    .line 118
    iget-object v0, p0, Lcom/a85/posproject/MainActivity;->strAmt:Lcom/a85/posproject/model/OrderBean;

    invoke-virtual {v0}, Lcom/a85/posproject/model/OrderBean;->getPayChannel()Ljava/lang/String;

    move-result-object v0

    invoke-direct {p0, v0}, Lcom/a85/posproject/MainActivity;->startPay(Ljava/lang/String;)V

    goto :goto_0

    .line 121
    :cond_0
    iget-object v0, p0, Lcom/a85/posproject/MainActivity;->mContext:Landroid/content/Context;

    invoke-static {v0}, Lcom/a85/posproject/utils/SharedPreUtils;->getSerialNo(Landroid/content/Context;)Ljava/lang/String;

    move-result-object v0

    invoke-static {v0}, Landroid/text/TextUtils;->isEmpty(Ljava/lang/CharSequence;)Z

    .line 133
    :goto_0
    return-void
.end method

.method private initView()V
    .locals 2

    .line 83
    const v0, 0x7f070022

    invoke-virtual {p0, v0}, Lcom/a85/posproject/MainActivity;->findViewById(I)Landroid/view/View;

    move-result-object v0

    new-instance v1, Lcom/a85/posproject/MainActivity$2;

    invoke-direct {v1, p0}, Lcom/a85/posproject/MainActivity$2;-><init>(Lcom/a85/posproject/MainActivity;)V

    invoke-virtual {v0, v1}, Landroid/view/View;->setOnClickListener(Landroid/view/View$OnClickListener;)V

    .line 89
    const v0, 0x7f070023

    invoke-virtual {p0, v0}, Lcom/a85/posproject/MainActivity;->findViewById(I)Landroid/view/View;

    move-result-object v0

    new-instance v1, Lcom/a85/posproject/MainActivity$3;

    invoke-direct {v1, p0}, Lcom/a85/posproject/MainActivity$3;-><init>(Lcom/a85/posproject/MainActivity;)V

    invoke-virtual {v0, v1}, Landroid/view/View;->setOnClickListener(Landroid/view/View$OnClickListener;)V

    .line 95
    const v0, 0x7f070024

    invoke-virtual {p0, v0}, Lcom/a85/posproject/MainActivity;->findViewById(I)Landroid/view/View;

    move-result-object v0

    new-instance v1, Lcom/a85/posproject/MainActivity$4;

    invoke-direct {v1, p0}, Lcom/a85/posproject/MainActivity$4;-><init>(Lcom/a85/posproject/MainActivity;)V//invoke-direct调用实例的直接方法

    invoke-virtual {v0, v1}, Landroid/view/View;->setOnClickListener(Landroid/view/View$OnClickListener;)V

    .line 101
    return-void
.end method

```

## 总结

smali语法还是在于多看多用，我也总是一段时间不用就忘。